openapi: 3.0.3
info:
  title: TailOn API Documentation
  description: |
    A web service for managing applications over Tailscale. This API allows you to
    start, stop, restart, and monitor applications remotely, with real-time log streaming
    capabilities via Server-Sent Events.
  version: 1.0.0
  contact:
    name: SierraSoftworks
    url: https://github.com/SierraSoftworks/tail-on
  license:
    name: MIT
    url: https://github.com/SierraSoftworks/tail-on/blob/main/LICENSE

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://{hostname}.tailnet-name.ts.net
    description: Tailscale network server
    variables:
      hostname:
        default: tail-on-server
        description: The hostname configured for the tail-on server on your Tailnet

paths:
  /api/v1/whoami:
    get:
      summary: Get current user information
      description: Returns information about the currently authenticated user
      operationId: whoami
      tags:
        - Authentication
      responses:
        '200':
          description: Current user information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              examples:
                anonymous:
                  summary: Anonymous user
                  value:
                    id: "$anonymous$"
                    display_name: Anonymous
                    login_name: ""
                    node: ""
                    is_anonymous: true
                tailscale_user:
                  summary: Tailscale authenticated user
                  value:
                    id: user123
                    display_name: John Doe
                    login_name: john@example.com
                    node: johns-laptop
                    is_anonymous: false

  /api/v1/apps:
    get:
      summary: List all configured applications
      description: Returns a list of all applications configured in the system with their current status
      operationId: getApps
      tags:
        - Applications
      responses:
        '200':
          description: List of applications
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/Application'
              example:
                echo-server:
                  config:
                    name: echo-server
                    path: /bin/sh
                    args: ["-c", "while true; do echo 'Hello' $(date); sleep 2; done"]
                    env: ["APP_NAME=echo-server"]
                  state: not_running
                  pid: 0
                counter:
                  config:
                    name: counter
                    path: /bin/sh
                    args: ["-c", "i=0; while true; do echo 'Counter:' $i; i=$((i+1)); sleep 1; done"]
                    env: ["APP_NAME=counter"]
                  state: running
                  pid: 12345
                  started_by:
                    id: user123
                    display_name: John Doe
                    login_name: john@example.com
                    node: johns-laptop
                    is_anonymous: false
                  started_at: "2025-08-07T12:00:00Z"

  /api/v1/apps/{app_name}:
    get:
      summary: Get application details
      description: Returns detailed information about a specific application
      operationId: getApp
      tags:
        - Applications
      parameters:
        - name: app_name
          in: path
          required: true
          description: Name of the application
          schema:
            type: string
          example: echo-server
      responses:
        '200':
          description: Application details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Application'
        '404':
          description: Application not found
          content:
            text/plain:
              schema:
                type: string
              example: "application echo-server not found"

  /api/v1/apps/{app_name}/start:
    post:
      summary: Start an application
      description: Starts the specified application if it's not already running
      operationId: startApp
      tags:
        - Application Control
      parameters:
        - name: app_name
          in: path
          required: true
          description: Name of the application to start
          schema:
            type: string
          example: echo-server
      responses:
        '200':
          description: Application started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
              example:
                status: started
        '400':
          description: Failed to start application (e.g., already running)
          content:
            text/plain:
              schema:
                type: string
              example: "application echo-server is already running"
        '404':
          description: Application not found
          content:
            text/plain:
              schema:
                type: string

  /api/v1/apps/{app_name}/stop:
    post:
      summary: Stop an application
      description: Stops the specified application if it's currently running
      operationId: stopApp
      tags:
        - Application Control
      parameters:
        - name: app_name
          in: path
          required: true
          description: Name of the application to stop
          schema:
            type: string
          example: echo-server
        - name: force
          in: query
          required: false
          description: Force stop the application using SIGKILL instead of SIGTERM
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Application stopped successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
              examples:
                normal_stop:
                  summary: Normal stop
                  value:
                    status: stopped
                force_stop:
                  summary: Force stop
                  value:
                    status: force_stopped
        '400':
          description: Failed to stop application (e.g., not running)
          content:
            text/plain:
              schema:
                type: string
              example: "application echo-server is not running"
        '404':
          description: Application not found
          content:
            text/plain:
              schema:
                type: string

  /api/v1/apps/{app_name}/restart:
    post:
      summary: Restart an application
      description: |
        Restarts the specified application by stopping it (if running) and then starting it again.
        This operation will succeed even if the application was not previously running.
      operationId: restartApp
      tags:
        - Application Control
      parameters:
        - name: app_name
          in: path
          required: true
          description: Name of the application to restart
          schema:
            type: string
          example: echo-server
      responses:
        '200':
          description: Application restarted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
              example:
                status: restarted
        '400':
          description: Failed to restart application
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Application not found
          content:
            text/plain:
              schema:
                type: string

  /api/v1/apps/{app_name}/logs:
    get:
      summary: Get application logs
      description: |
        Returns application logs. The response format depends on the Accept header:
        - `application/json` (default): Returns logs as JSON array
        - `text/event-stream`: Streams logs in real-time using Server-Sent Events
      operationId: getLogs
      tags:
        - Logs
      parameters:
        - name: app_name
          in: path
          required: true
          description: Name of the application
          schema:
            type: string
          example: echo-server
        - name: Accept
          in: header
          required: false
          description: Response format preference
          schema:
            type: string
            enum:
              - application/json
              - text/event-stream
            default: application/json
      responses:
        '200':
          description: Application logs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LogEntry'
              example:
                - timestamp: "2025-08-07T12:00:00Z"
                  message: "Hello Wed Aug  7 12:00:00 UTC 2025"
                  source: "stdout"
                - timestamp: "2025-08-07T12:00:02Z"
                  message: "Hello Wed Aug  7 12:00:02 UTC 2025"
                  source: "stdout"
            text/event-stream:
              schema:
                type: string
                format: text/event-stream
              example: |
                data: {"timestamp":"2025-08-07T12:00:00Z","message":"Hello Wed Aug  7 12:00:00 UTC 2025","source":"stdout"}
                data: {"timestamp":"2025-08-07T12:00:02Z","message":"Hello Wed Aug  7 12:00:02 UTC 2025","source":"stdout"}
        '404':
          description: Application not found
          content:
            text/plain:
              schema:
                type: string

components:
  schemas:
    User:
      type: object
      required:
        - id
        - display_name
        - is_anonymous
      properties:
        id:
          type: string
          description: Unique identifier for the user
          example: user123
        display_name:
          type: string
          description: Human-readable name for the user
          example: John Doe
        login_name:
          type: string
          description: User's login name or email (empty for anonymous users)
          example: john@example.com
        node:
          type: string
          description: Tailscale node name (empty for anonymous users)
          example: johns-laptop
        is_anonymous:
          type: boolean
          description: Whether this is an anonymous user
          example: false

    Application:
      type: object
      required:
        - config
        - state
      properties:
        config:
          $ref: '#/components/schemas/ApplicationConfig'
        state:
          type: string
          enum:
            - not_running
            - running
            - stopping
          description: Current state of the application
          example: running
        pid:
          type: integer
          description: Process ID of the running application (0 if not running)
          example: 12345
        started_by:
          $ref: '#/components/schemas/User'
          description: User who started the application (only present if running)
        started_at:
          type: string
          format: date-time
          description: Timestamp when the application was started (only present if running)
          example: "2025-08-07T12:00:00Z"

    ApplicationConfig:
      type: object
      required:
        - name
        - path
        - args
        - env
      properties:
        name:
          type: string
          description: Unique name of the application
          example: echo-server
        path:
          type: string
          description: Path to the executable
          example: /bin/sh
        args:
          type: array
          items:
            type: string
          description: Command line arguments
          example: ["-c", "echo 'Hello World'"]
        env:
          type: array
          items:
            type: string
          description: Environment variables in KEY=VALUE format
          example: ["APP_NAME=echo-server", "DEBUG=true"]

    LogEntry:
      type: object
      required:
        - timestamp
        - message
        - source
      properties:
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the log entry was created
          example: "2025-08-07T12:00:00Z"
        message:
          type: string
          description: Log message content
          example: "Hello World"
        source:
          type: string
          enum:
            - stdout
            - stderr
            - audit
          description: Source of the log entry
          example: stdout

    StatusResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Operation status
          enum:
            - started
            - stopped
            - force_stopped
            - restarted
          example: started

    Error:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Error description
          example: "application not found"

  responses:
    NotFound:
      description: Application not found
      content:
        text/plain:
          schema:
            type: string
          example: "application echo-server not found"

    BadRequest:
      description: Invalid request or operation failed
      content:
        text/plain:
          schema:
            type: string
          example: "application echo-server is already running"

    InternalServerError:
      description: Internal server error
      content:
        text/plain:
          schema:
            type: string
          example: "Internal server error"

tags:
  - name: Applications
    description: Operations for listing and viewing application information
  - name: Application Control
    description: Operations for controlling application lifecycle (start/stop/restart)
  - name: Logs
    description: Operations for accessing application logs

externalDocs:
  description: GitHub Repository
  url: https://github.com/SierraSoftworks/tail-on
